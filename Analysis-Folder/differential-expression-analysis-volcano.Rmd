---
title: "differential expression analysis"
author: "Manuel Cortes"
date: "2023-09-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Attach the DESeq2 library
library(DESeq2)

# Attach the ggplot2 library for plotting
library(ggplot2)

# We will need this so we can use the pipe: %>%
library(magrittr)

# Human Annotation
library(org.Hs.eg.db)

set.seed(12345)
```

# Loading in the data

```{r}
# Define the file path to the data directory
data_dir <- file.path("data", "SRP076307")

# Declare the file path to the gene expression matrix file
data_file <- file.path(data_dir, "SRP076307.tsv")

# Declare the file path to the metadata file
metadata_file <- file.path(data_dir, "metadata_SRP076307.tsv")

# Read in metadata TSV file
metadata <- readr::read_tsv(metadata_file)

# Read in data TSV file
expression_df <- readr::read_tsv(data_file) %>%
  tibble::column_to_rownames("Gene")
```

# Preliminary metadata preprocessing

```{r}
# Make the data in the order of the metadata
expression_df <- expression_df %>%
  dplyr::select(metadata$refinebio_accession_code)

# Check if this is in the same order
all.equal(colnames(expression_df), metadata$refinebio_accession_code)

#This will add a new column that contains the group to which the samples belong to
metadata <- metadata %>%
  dplyr::mutate(Group = stringr::str_extract(refinebio_title, "^[A-Z]{3}"))

# Extract unique values of the Group column, but exclude "CTL"
unique_groups <- setdiff(unique(metadata$Group), "CTL")

# Make sure "CTL" is the first level, followed by the other unique values
ordered_levels <- c("CTL", sort(unique_groups))

# Convert the Group column to a factor with these levels
metadata <- metadata %>%
  dplyr::mutate(Group = factor(Group, levels = ordered_levels))

dplyr::select(metadata, refinebio_title, Group)


```

# Preliminary data preprocessing

```{r}
# Define a minimum counts cutoff and filter the data to include
# only rows (genes) that have total counts above the cutoff
filtered_expression_df <- expression_df %>%
  dplyr::filter(rowSums(.) >= 10)

gene_matrix <- round(filtered_expression_df)

ddset <- DESeqDataSetFromMatrix(
  # Here we supply non-normalized count data
  countData = gene_matrix,
  # Supply the `colData` with our metadata data frame
  colData = metadata,
  # Supply our experimental variable to `design`
  design = ~Group
)
```

# Analysis

# For DESeq, please see differential-expression-analysis.Rmd.
# Here, we will simply load the result from it

```{r}

# Define the file path
file_path <- file.path("results", "SRP076307_diff_expr_results.tsv")

# Read the file
deseq_df <- readr::read_tsv(file_path)

```

# Plotting - Volcano Plot

```{r}
# We'll assign this as `volcano_plot`
volcano_plot <- EnhancedVolcano::EnhancedVolcano(
  deseq_df,
  lab = deseq_df$Gene,
  x = "log2FoldChange",
  y = "padj",
  pCutoff = 0.01 # Loosen the cutoff since we supplied corrected p-values
)

# Print out plot here
volcano_plot

ggsave(
  plot = volcano_plot,
  file.path("plots/", "SRP123625_volcano_plot.png")
) # Replace with a plot name relevant to your data
```
