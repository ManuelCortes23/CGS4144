---
title: "differential expression analysis"
author: "Manuel Cortes"
date: "2023-09-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Attach the DESeq2 library
library(DESeq2)

# Attach the ggplot2 library for plotting
library(ggplot2)

# We will need this so we can use the pipe: %>%
library(magrittr)

# Human Annotation
library(org.Hs.eg.db)

set.seed(12345)
```

# Analysis

# For DESeq, please see differential-expression-analysis.Rmd.
# Here, we will simply load the result from it

```{r}

# Define the file path
file_path <- file.path("results", "SRP076307_diff_expr_results_ensembl.tsv")

# Read the file
deseq_df <- readr::read_tsv(file_path)

```

# CLustering analysis

```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("clusterProfiler")
BiocManager::install("biomaRt")

```


```{r}

library(biomaRt)  
library(clusterProfiler)



# # Filter for significantly differentially expressed genes using the threshold column
# sig_genes_df <- deseq_df %>%
#   dplyr::filter(threshold == TRUE)
# entrez_ids <- sig_genes_df$Gene

# Sorting by the absolute value of log2FoldChange in descending order
top_genes_df <- deseq_df %>%
  dplyr::arrange(dplyr::desc(abs(log2FoldChange))) %>%
  dplyr::slice_head(n = 5000)


top_genes_id <- top_genes_df$Gene


```

# Load in original data from differential-expression-analysis.Rmd and do some preprocessing

# For this, we will need the gene_matrix variable to exist

```{r}

top_genes_matrix <- gene_matrix[top_genes_id,]

scaled_matrix <- t(scale(top_genes_matrix))

kmeans_result <- kmeans(scaled_matrix, centers = 3)

pca_result <- prcomp(scaled_matrix, scale.=FALSE)
plot(pca_result$x[,1:2], col=kmeans_result$cluster, pch = 16, xlab = "PC1", ylab = "PC2")

```

```{r}

# 1. Calculate the distance matrix
dist_matrix <- dist(scaled_matrix, method = "euclidean")

# 2. Perform Hierarchical Clustering
hclust_result <- hclust(dist_matrix, method = "complete")

# 3. Visualize the Dendrogram
plot(hclust_result)

# 4. Cut the dendrogram to form a specific number of clusters (e.g., 3 clusters)
clusters <- cutree(hclust_result, k = 3)

# 5. Visualize the clusters on the PCA plot (assuming `pca_result` was computed earlier)
plot(pca_result$x[,1:2], col=clusters, pch=16, xlab="PC1", ylab="PC2")

```

